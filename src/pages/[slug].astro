---
import Metadata from '../components/Metadata.astro'
import Header from '../components/Header.astro'
import Tags from '../components/Tags.astro'
import Footer from '../components/Footer.astro'
import { Markdown } from 'astro/components'
import NavHeader from '../components/NavHeader.astro'

export async function getStaticPaths({ rss }) {
    const posts = Astro.fetchContent('../_posts/*.md')
    const sortedPosts = posts.sort((a, b) => new Date(b.date) - new Date(a.date))

    rss({
        title: 'polpiella.dev',
        description: 'A blog about iOS development and software engineering.',
        customData: `<language>en-us</language>`,
        items: sortedPosts.map(item => ({
            title: item.title,
            description: item.astro.html,
            link: `https://${item.slug}`,
            pubDate: item.date,
        })),
        dest: '/rss.xml'
    })

    return posts.map((post) => {
        return {
            params: { slug: post.slug },
            props: { post }
        }
    })
}

const { post } = Astro.props
const { title, excerpt, tags, date, readtime, astro } = post
const { source } = astro
const formattedDate = new Date(date).toLocaleDateString('en-US', {
    year: 'numeric', month: 'long', day: 'numeric'
})
const fullImageURL = `https://www.polpiella.dev/api/thumbnail?title=${encodeURI(title)}`
---
<html lang="en">
<NavHeader title={title} description={excerpt} image={fullImageURL}>
    <link rel="stylesheet" href={Astro.resolve('../styles/blog-detail.css')} />
</NavHeader>

<body class="dark:bg-gray-900">
    <Header />
    <div class="w-full">
        <article class="prose prose-lg dark:prose-invert prose-pre:shadow-lg prose-img:shadow-lg mx-auto my-0 px-3">
            <header>
                <h3 class=" text-zinc-400 m-0 font-bold">{formattedDate}</h3>
                <div class="flex flex-col gap-5">
                    <h1 class="m-0">{title}</h1>
                    <Tags tags={tags} />
                    <Metadata readtime={readtime} />
                    <hr class="m-0" />
                </div>
            </header>
            <Markdown content={source} />
        </article>
    </div>
    <Footer />
</body>
</html>